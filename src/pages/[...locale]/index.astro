---
import { render, getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import config, { monolocale } from "$config";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Heatmap from "$components/Heatmap.svelte";
import Logo from "$icons/site-logo.svg";
import i18nit from "$i18n";

export async function getStaticPaths() {
	// Create path for each locale, omitting default locale from URL
	return config.i18n.locales.map(locale => ({ params: { locale: config.i18n.defaultLocale === locale ? undefined : locale } }));
}

const { locale = config.i18n.defaultLocale } = Astro.params;

const t = i18nit(locale);

// Get preface content for current locale, sorted by timestamp (latest first)
const prefaces = (
	await getCollection("preface", preface => {
		// Handle single locale setup
		if (monolocale) return true;

		// Extract language and ID from file path structure
		const [language, id] = preface.id.split("/");
		preface.id = id;

		// Filter by current locale
		return language === locale;
	})
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Get published christianity posts for current locale
let christianityPosts = [];
try {
	christianityPosts = await getCollection("christianity", post => {
		Reflect.set(post, "type", "christianity");
		let published = !post.data.draft;
		let localed = monolocale || post.id.split("/")[0] === locale;
		return published && localed;
	});
} catch (e) {
	christianityPosts = [];
}

// Get published technology posts for current locale
let technologyPosts = [];
try {
	technologyPosts = await getCollection("technology", post => {
		Reflect.set(post, "type", "technology");
		let published = !post.data.draft;
		let localed = monolocale || post.id.split("/")[0] === locale;
		return published && localed;
	});
} catch (e) {
	technologyPosts = [];
}

// Keep `notes` and `jottings` variables for compatibility with components (map to new sections)
const notes = christianityPosts;
const jottings = technologyPosts;

// Combine contents
let items: { id: string; type?: string; data: { timestamp: Date; tags?: string[]; [key: string]: any } }[] = [];

// Determine which sections to include
const sections = config.latest || "*";

// Add contents based on config
if (sections === "*" || sections.includes("christianity")) items = items.concat(christianityPosts);
if (sections === "*" || sections.includes("technology")) items = items.concat(technologyPosts);

// Get the latest content for display
const latest = items.sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime())[0];

// Get the latest preface for display
const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);
// Localized prologue text (fallback to global config.prologue)
const prologueText = t("prologue") || config.prologue;
// Locale switch: label and target locale/url
const otherLocale = locale === "en" ? "vi" : "en";
const localeSwitchLabel = locale === "en" ? "Phiên bản tiếng Việt →" : "English version →";
const otherUrl = getRelativeLocaleUrl(otherLocale, "/");
---

<Base title={t("navigation.home")} {locale}>
	<main class="flex flex-col gap-5 sm:gap-20 grow">
		<header class="flex items-center justify-center flex-wrap-reverse grow-[0.6]">
			{prologueText && (
				<div class="me-auto">
					<article class="font-cursive font-thin text-xl sm:text-2xl leading-loose whitespace-pre-line">{prologueText}</article>
					<a href={otherUrl} class="text-sm text-secondary mt-1 inline-block">{localeSwitchLabel}</a>
				</div>
			)}
			<Logo width={100} />
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href={getRelativeLocaleUrl(locale, "/preface")} class="self-end my-2 text-sm text-secondary">
						—— {Time.date.locale(preface.data.timestamp, locale)}
					</a>
				</section>
			)
		}

		{
			latest && (
				<footer class="flex items-center justify-center flex-wrap-reverse gap-10">
					<Heatmap {locale} {notes} {jottings} />

					<blockquote class="grow flex flex-col">
						<h4>{t("home.latest")}</h4>
						<div class="flex flex-col sm:flex-row justify-between gap-1 mt-1">
							<a href={getRelativeLocaleUrl(locale, `/${latest.type}/${monolocale ? latest.id : latest.id.split("/").slice(1).join("/")}`)} class="link">
								{latest.data.series && `${latest.data.series} | `}
								{latest.data.title}
							</a>
							<div class="flex gap-1">
								{latest.data.tags?.map(tag => (
									<a href={`${getRelativeLocaleUrl(locale, `/${latest.type}`)}?tag=${encodeURIComponent(tag)}`} class="text-remark text-sm link">
										#{tag}
									</a>
								))}
							</div>
						</div>
						<time datetime={latest.data.timestamp.toISOString()} class="text-remark font-mono text-xs">
							{Time(latest.data.timestamp)}
						</time>
					</blockquote>
				</footer>
			)
		}
	</main>
</Base>
